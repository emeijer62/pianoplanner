<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pianos - PianoPlanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="apple-style.css">
    <link rel="stylesheet" href="icons.css?v=20260109b">
    <link rel="stylesheet" href="ios-mobile.css?v=20260110b">
    <link rel="stylesheet" href="ios-standalone.css" media="all and (display-mode: standalone)">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/js/pwa.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/offline-store.js"></script>
    <script src="/js/offline-fetch.js"></script>
    <script src="/js/offline-ui.js"></script>
    <script src="icons.js?v=20260109" defer></script>
    <style>
        .pianos-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .page-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box input {
            padding: 8px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 14px;
            width: 240px;
            font-family: var(--font-family);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px var(--blue-light);
        }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-badge {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all var(--transition-fast);
        }
        
        .stat-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-badge .label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-badge .number {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-badge.warning {
            border-color: var(--orange);
            background: var(--orange-light);
        }

        .stat-badge.warning .number {
            color: var(--orange);
        }

        /* Piano Grid */
        .pianos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        /* Piano Table */
        .pianos-table-container {
            background: var(--white);
            border-radius: 10px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .pianos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pianos-table th {
            background: var(--gray-50);
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--gray-200);
        }

        .pianos-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .pianos-table th.sortable:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .pianos-table th.sortable .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
            transition: opacity 0.15s ease;
        }

        .pianos-table th.sortable .sort-icon::after {
            content: '↕';
            font-size: 10px;
        }

        .pianos-table th.sortable.sort-asc {
            color: var(--primary-color);
            background: #e8f4fd;
        }

        .pianos-table th.sortable.sort-asc .sort-icon {
            opacity: 1;
        }

        .pianos-table th.sortable.sort-asc .sort-icon::after {
            content: '↑';
        }

        .pianos-table th.sortable.sort-desc {
            color: var(--primary-color);
            background: #e8f4fd;
        }

        .pianos-table th.sortable.sort-desc .sort-icon {
            opacity: 1;
        }

        .pianos-table th.sortable.sort-desc .sort-icon::after {
            content: '↓';
        }

        .pianos-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
            font-size: 13px;
        }

        .pianos-table tr:last-child td {
            border-bottom: none;
        }

        .pianos-table tr:hover {
            background: var(--gray-50);
        }

        .piano-brand-cell {
            font-weight: 600;
            color: var(--gray-900);
        }

        .piano-model-cell {
            color: var(--gray-500);
            font-size: 12px;
        }

        .piano-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
        }

        .piano-type-badge.grand {
            background: var(--green-light);
            color: var(--green);
        }

        .piano-type-badge.upright {
            background: var(--blue-light);
            color: var(--blue);
        }

        .piano-type-badge.digital {
            background: var(--purple-light);
            color: var(--purple);
        }

        .customer-link {
            color: var(--blue);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customer-link:hover {
            text-decoration: underline;
        }

        .no-customer {
            color: var(--gray-400);
            font-style: italic;
        }

        .service-status {
            font-size: 13px;
        }

        .service-due {
            color: var(--orange);
            font-weight: 600;
        }

        .service-ok {
            color: var(--green);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 14px;
        }

        .btn-icon:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .btn-icon.edit:hover {
            background: var(--blue-light);
            border-color: var(--blue);
            color: var(--blue);
        }

        .btn-icon.delete:hover {
            background: #fee2e2;
            border-color: var(--red);
            color: var(--red);
        }

        .piano-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .piano-card:hover {
            border-color: var(--gray-300);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .piano-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .piano-brand {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .piano-model {
            color: var(--gray-500);
            font-size: 14px;
            margin-top: 2px;
        }

        .piano-type {
            background: var(--gray-100);
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
        }

        .piano-type.grand {
            background: var(--green-light);
            color: var(--green);
        }

        .piano-type.upright {
            background: var(--blue-light);
            color: var(--blue);
        }

        .piano-type.digital {
            background: var(--purple-light);
            color: var(--purple);
        }

        .piano-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .piano-detail {
            color: var(--gray-500);
        }

        .piano-detail span {
            color: var(--gray-900);
            font-weight: 500;
        }

        .piano-customer {
            background: var(--gray-50);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .piano-service {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .service-due {
            color: var(--red);
            font-weight: 600;
        }

        .service-ok {
            color: var(--green);
            font-weight: 500;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 80px 24px;
            color: var(--gray-500);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin: 0 0 12px 0;
            font-size: 22px;
            color: var(--gray-900);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 70%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        #piano-form {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .modal-body {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .modal-footer {
            flex-shrink: 0;
            padding: 16px 24px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: white;
        }

        @media (max-width: 768px) {
            .modal {
                width: 95%;
                max-width: none;
            }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        /* Service History Panel */
        .service-panel {
            margin-top: 24px;
            border-top: 1px solid #e8e8e8;
            padding-top: 24px;
        }

        .service-panel h3 {
            margin: 0 0 16px 0;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .service-item {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .service-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .service-type {
            font-weight: 500;
        }

        .service-date {
            color: #666;
            font-size: 0.85rem;
        }

        .service-notes {
            font-size: 0.85rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                flex-direction: column;
            }

            .search-box input {
                width: 100%;
            }

            .pianos-grid {
                grid-template-columns: 1fr;
            }
            
            .pianos-container {
                padding: 16px;
                padding-bottom: calc(83px + 20px) !important;
            }
            
            /* Hide table header on mobile */
            .pianos-table thead {
                display: none;
            }
            
            /* Transform table rows to cards on mobile */
            .pianos-table,
            .pianos-table tbody {
                display: block;
            }
            
            .pianos-table tr {
                display: flex;
                flex-wrap: wrap;
                padding: 16px;
                border-bottom: 1px solid var(--gray-100);
                gap: 8px;
                align-items: flex-start;
            }
            
            .pianos-table tr:last-child {
                border-bottom: none;
            }
            
            .pianos-table td {
                display: block;
                padding: 0;
                border: none;
            }
            
            /* Brand - full width, larger */
            .pianos-table td.piano-brand-cell {
                width: 100%;
                font-size: 17px;
                font-weight: 600;
                order: 1;
            }
            
            /* Model - inline */
            .pianos-table td.piano-model-cell {
                font-size: 14px;
                color: var(--gray-500);
                order: 2;
            }
            
            /* Type badge */
            .pianos-table td.piano-type-cell {
                order: 3;
                margin-left: auto;
            }
            
            /* Customer - full width */
            .pianos-table td.piano-customer-cell {
                width: 100%;
                order: 4;
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid var(--gray-100);
            }
            
            .pianos-table td.piano-customer-cell .customer-link {
                font-size: 14px;
            }
            
            /* Last tuning - full width */
            .pianos-table td.piano-service-cell {
                width: 100%;
                order: 5;
                font-size: 13px;
                margin-top: 4px;
            }
            
            /* Action buttons - full width */
            .pianos-table td.piano-actions-cell {
                width: 100%;
                order: 6;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--gray-100);
            }
            
            .pianos-table .action-buttons {
                width: 100%;
                justify-content: flex-start;
            }
            
            .pianos-table .action-buttons .btn-icon {
                flex: 1;
                width: auto;
                height: 40px;
                font-size: 13px;
                gap: 6px;
            }
            
            .stats-row {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            
            .stat-badge {
                padding: 16px;
            }
            
            .stat-badge .number {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <a href="/dashboard.html" class="nav-logo">
                <span class="logo-piano"><i data-lucide="piano"></i></span> PianoPlanner
            </a>
            <div class="nav-links">
                <a href="/dashboard.html" class="nav-link"><i data-lucide="calendar"></i> Dashboard</a>
                <a href="/customers.html" class="nav-link"><i data-lucide="users"></i> Customers</a>
                <a href="/pianos.html" class="nav-link active"><i data-lucide="piano"></i> Pianos</a>
                <a href="/settings.html" class="nav-link"><i data-lucide="settings"></i> Settings</a>
                <a href="/guide.html" class="nav-link"><i data-lucide="help-circle"></i> Help</a>
            </div>
            <div class="nav-user">
                <a href="/booking.html" class="btn btn-primary btn-sm"><i data-lucide="plus" style="width: 14px; height: 14px;"></i> Appointment</a>
                <a href="/auth/logout" class="btn btn-secondary btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <main class="pianos-container">
        <div class="page-header">
            <h1 style="display: flex; align-items: center; gap: 12px;"><i data-lucide="piano" style="width: 28px; height: 28px;"></i> <span data-i18n="pianos.title">Pianos</span></h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search pianos...">
                </div>
                <button class="btn btn-secondary" onclick="refreshPianos()" title="Refresh"><i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i></button>
                <button class="btn btn-primary" onclick="openPianoModal()"><i data-lucide="plus" style="width: 16px; height: 16px;"></i> <span data-i18n="pianos.addPiano">New Piano</span></button>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-badge">
                <span class="label">Total</span>
                <span class="number" id="total-pianos">0</span>
                <span data-i18n="pianos.title">Pianos total</span>
            </div>
            <div class="stat-badge warning" id="due-badge" style="display: none;">
                <span class="number" id="due-count">0</span>
                <span>Service needed</span>
            </div>
        </div>

        <div id="pianos-table-container" class="pianos-table-container">
            <table class="pianos-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="brand" onclick="sortPianos('brand')" data-i18n="pianos.brand">Brand <span class="sort-icon"></span></th>
                        <th data-i18n="pianos.model">Model</th>
                        <th data-i18n="pianos.type">Type</th>
                        <th class="sortable" data-sort="customer" onclick="sortPianos('customer')" data-i18n="customers.title">Customer <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort="lastTuning" onclick="sortPianos('lastTuning')" data-i18n="pianos.lastTuning">Last tuning <span class="sort-icon"></span></th>
                        <th style="width: 100px;"></th>
                    </tr>
                </thead>
                <tbody id="pianos-tbody">
                </tbody>
            </table>
        </div>

        <div id="pianos-empty" class="empty-state" style="display: none;">
            <div class="icon"><i data-lucide="piano" style="width: 64px; height: 64px;"></i></div>
            <h3 data-i18n="pianos.noPianos">No pianos yet</h3>
            <p>Add your first piano to get started</p>
        </div>
    </main>

    <!-- Piano Modal - Apple Style -->
    <div id="piano-modal" class="apple-modal">
        <div class="apple-modal-backdrop" onclick="closeModal()"></div>
        <div class="apple-modal-content" style="max-width: 600px;">
            <div class="apple-modal-header">
                <button class="apple-modal-close" onclick="closeModal()">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor">
                        <path d="M1.41 0L5 3.59 8.59 0 10 1.41 6.41 5 10 8.59 8.59 10 5 6.41 1.41 10 0 8.59 3.59 5 0 1.41z"/>
                    </svg>
                </button>
                <h2 id="modal-title" class="apple-modal-title">New Piano</h2>
                <div style="width: 30px;"></div>
            </div>
            <form id="piano-form" class="apple-modal-body">
                <input type="hidden" id="piano-id">
                
                <!-- Section 1: Piano Details -->
                <div class="apple-form-section">
                    <div class="apple-form-section-title">Piano Details</div>
                    
                    <div class="apple-form-grid">
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-brand">Brand *</label>
                            <input type="text" id="piano-brand" class="apple-form-input" required placeholder="Steinway, Yamaha, Bösendorfer...">
                        </div>
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-model">Model</label>
                            <input type="text" id="piano-model" class="apple-form-input" placeholder="B-211, U3, etc.">
                        </div>
                    </div>

                    <div class="apple-form-grid">
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-type">Type</label>
                            <select id="piano-type" class="apple-form-select">
                                <option value="upright">Piano</option>
                                <option value="grand">Grand piano</option>
                            </select>
                        </div>
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-year">Year built</label>
                            <input type="number" id="piano-year" class="apple-form-input" min="1800" max="2030" placeholder="1985">
                        </div>
                    </div>

                    <div class="apple-form-grid">
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-serial">Serial number</label>
                            <input type="text" id="piano-serial" class="apple-form-input" placeholder="12345678">
                        </div>
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-finish">Finish</label>
                            <input type="text" id="piano-finish" class="apple-form-input" placeholder="Black polished">
                        </div>
                    </div>
                </div>

                <div class="apple-form-divider"></div>

                <!-- Section 2: Owner & Service -->
                <div class="apple-form-section">
                    <div class="apple-form-section-title">Owner & Service</div>
                    
                    <div class="apple-form-grid">
                        <div class="apple-form-field" style="position: relative;">
                            <label class="apple-form-label" for="piano-customer-search">Customer</label>
                            <input type="text" id="piano-customer-search" class="apple-form-input" placeholder="Search by name..." autocomplete="off">
                            <input type="hidden" id="piano-customer" value="">
                            <div id="piano-customer-results" class="autocomplete-suggestions apple-autocomplete" style="display: none;"></div>
                        </div>
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-condition">Condition</label>
                            <select id="piano-condition" class="apple-form-select">
                                <option value="excellent">Excellent</option>
                                <option value="good" selected>Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                    </div>

                    <div class="apple-form-grid">
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-location">Location in home</label>
                            <input type="text" id="piano-location" class="apple-form-input" placeholder="Living room">
                        </div>
                        <div class="apple-form-field">
                            <label class="apple-form-label" for="piano-interval">Service interval</label>
                            <select id="piano-interval" class="apple-form-select">
                                <option value="3">3 months</option>
                                <option value="6" selected>6 months</option>
                                <option value="12">12 months</option>
                            </select>
                        </div>
                    </div>

                    <div class="apple-form-field">
                        <label class="apple-form-label" for="piano-notes">Notes</label>
                        <textarea id="piano-notes" class="apple-form-textarea" placeholder="Special notes about this piano..."></textarea>
                    </div>
                </div>

                <!-- Service Panel (only when editing) -->
                <div id="service-panel" class="apple-form-section apple-service-panel" style="display: none;">
                    <div class="apple-form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span data-i18n="pianos.serviceHistory">Service History</span>
                        <button type="button" class="apple-btn-secondary" onclick="openServiceModal()" style="padding: 6px 12px; font-size: 13px;" data-i18n="pianos.addService">+ Service</button>
                    </div>
                    <div id="service-list" class="service-list">
                        <p style="color: var(--gray-500); text-align: center; padding: 12px;" data-i18n="pianos.noServiceHistory">No service history yet</p>
                    </div>
                </div>
                
                <div class="apple-form-actions">
                    <button type="button" id="delete-btn" class="apple-btn-danger" onclick="deletePiano()" style="display: none; margin-right: auto;">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                        <span data-i18n="pianos.deletePiano">Delete</span>
                    </button>
                    <button type="button" class="apple-btn-secondary" onclick="closeModal()" data-i18n="common.cancel">Cancel</button>
                    <button type="submit" class="apple-btn-primary" id="submit-btn">
                        <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                        <span data-i18n="common.save">Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- iOS Toast for save feedback -->
    <div id="ios-toast" class="ios-toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span id="ios-toast-message">Saved!</span>
    </div>

    <!-- Service Modal -->
    <div id="service-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add Service</h2>
                <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            </div>
            <form id="service-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="service-type">Service type</label>
                        <select id="service-type">
                            <option value="tuning">Tuning</option>
                            <option value="repair">Repair</option>
                            <option value="regulation">Regulation</option>
                            <option value="voicing">Voicing</option>
                            <option value="cleaning">Cleaning</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="service-date">Date</label>
                        <input type="date" id="service-date" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="service-pitch-before">Pitch before</label>
                            <input type="text" id="service-pitch-before" placeholder="435">
                        </div>
                        <div class="form-group">
                            <label for="service-pitch-after">Pitch after</label>
                            <input type="text" id="service-pitch-after" placeholder="440">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="service-work">Work performed</label>
                        <textarea id="service-work" placeholder="Describe what was done..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="service-observations">Observations</label>
                        <textarea id="service-observations" placeholder="Issues found or special notes..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="service-recommendations">Recommendations</label>
                        <textarea id="service-recommendations" placeholder="Recommendations for the customer..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeServiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allPianos = [];
        let allCustomers = [];
        let currentPianoId = null;
        let currentSort = { field: 'lastTuning', direction: 'asc' }; // Default: oudste stembeurt eerst

        // Check login
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                if (!data.loggedIn) {
                    window.location.href = '/';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = '/';
                return false;
            }
        }

        // Merk wordt nu als vrij tekstveld ingevoerd

        // Load customers for searchable dropdown
        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                const data = await response.json();
                allCustomers = data.customers || [];
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        // Customer search functionality for piano modal
        function initCustomerSearch() {
            const searchInput = document.getElementById('piano-customer-search');
            const hiddenInput = document.getElementById('piano-customer');
            const resultsContainer = document.getElementById('piano-customer-results');
            
            if (!searchInput || !resultsContainer) return;
            
            // Focus event - show dropdown if there's text or show all customers
            searchInput.addEventListener('focus', () => {
                const query = searchInput.value.trim().toLowerCase();
                if (query.length > 0 || allCustomers.length <= 15) {
                    showCustomerResults(query);
                }
            });
            
            // Input event - search while typing
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim().toLowerCase();
                // Clear selection if user is typing
                if (hiddenInput.value) {
                    hiddenInput.value = '';
                }
                showCustomerResults(query);
            });
            
            // Blur event - hide dropdown (with delay for click)
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    resultsContainer.style.display = 'none';
                }, 200);
            });
            
            // Clear button functionality - clear on double click or when input is cleared
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    resultsContainer.style.display = 'none';
                    searchInput.blur();
                } else if (e.key === 'Backspace' && searchInput.value === '') {
                    hiddenInput.value = '';
                }
            });
        }
        
        // Show customer search results
        function showCustomerResults(query) {
            const resultsContainer = document.getElementById('piano-customer-results');
            const hiddenInput = document.getElementById('piano-customer');
            const searchInput = document.getElementById('piano-customer-search');
            
            let filtered = allCustomers;
            
            if (query.length > 0) {
                filtered = allCustomers.filter(c => {
                    const name = (c.name || '').toLowerCase();
                    const nameParts = name.split(' ');
                    
                    // Match against full name, first name, or last name
                    return name.includes(query) ||
                           nameParts.some(part => part.startsWith(query));
                });
            }
            
            // Limit to 10 results
            filtered = filtered.slice(0, 10);
            
            if (filtered.length === 0 && query.length > 0) {
                resultsContainer.innerHTML = `
                    <div class="autocomplete-item no-results" style="color: var(--gray-500); font-style: italic;">
                        No customers found
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }
            
            if (filtered.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Add "No customer linked" option at the top
            let html = `
                <div class="autocomplete-item ${!hiddenInput.value ? 'selected' : ''}" 
                     onclick="selectPianoCustomer('', 'No customer linked')">
                    <span style="color: var(--gray-500);">No customer linked</span>
                </div>
            `;
            
            html += filtered.map(c => `
                <div class="autocomplete-item ${hiddenInput.value === c.id ? 'selected' : ''}" 
                     onclick="selectPianoCustomer('${c.id}', '${(c.name || '').replace(/'/g, "\\'")}')">
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 500;">${c.name || 'Unknown'}</span>
                        ${c.city ? `<span style="font-size: 12px; color: var(--gray-500);">${c.city}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }
        
        // Select customer from search results
        function selectPianoCustomer(customerId, customerName) {
            const searchInput = document.getElementById('piano-customer-search');
            const hiddenInput = document.getElementById('piano-customer');
            const resultsContainer = document.getElementById('piano-customer-results');
            
            hiddenInput.value = customerId;
            searchInput.value = customerId ? customerName : '';
            resultsContainer.style.display = 'none';
        }
        
        // Set customer in search field (for editing)
        function setCustomerSearchValue(customerId) {
            const searchInput = document.getElementById('piano-customer-search');
            const hiddenInput = document.getElementById('piano-customer');
            
            if (customerId) {
                const customer = allCustomers.find(c => c.id === customerId);
                if (customer) {
                    searchInput.value = customer.name || '';
                    hiddenInput.value = customerId;
                    return;
                }
            }
            
            searchInput.value = '';
            hiddenInput.value = '';
        }

        // Laad piano's
        async function loadPianos() {
            try {
                const response = await fetch('/api/pianos');
                const data = await response.json();
                allPianos = data.pianos || [];
                
                document.getElementById('total-pianos').textContent = allPianos.length;
                
                // Check due pianos
                const dueResponse = await fetch('/api/pianos/due');
                const dueData = await dueResponse.json();
                if (dueData.total > 0) {
                    document.getElementById('due-badge').style.display = 'flex';
                    document.getElementById('due-count').textContent = dueData.total;
                }
                
                renderPianos(allPianos);
            } catch (error) {
                console.error('Error loading pianos:', error);
            }
        }

        // Sort pianos
        function sortPianos(field) {
            // Toggle direction if same field
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.pianos-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === field) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Sort the pianos
            const sorted = [...allPianos].sort((a, b) => {
                let valA, valB;
                
                switch (field) {
                    case 'brand':
                        valA = (a.brand || '').toLowerCase();
                        valB = (b.brand || '').toLowerCase();
                        break;
                    case 'customer':
                        const custA = allCustomers.find(c => c.id === a.customerId);
                        const custB = allCustomers.find(c => c.id === b.customerId);
                        valA = (custA?.name || '').toLowerCase();
                        valB = (custB?.name || '').toLowerCase();
                        break;
                    case 'lastTuning':
                        // Pianos without tuning date go to the end
                        valA = a.lastTuningDate ? new Date(a.lastTuningDate).getTime() : (currentSort.direction === 'asc' ? Infinity : -Infinity);
                        valB = b.lastTuningDate ? new Date(b.lastTuningDate).getTime() : (currentSort.direction === 'asc' ? Infinity : -Infinity);
                        break;
                    default:
                        valA = '';
                        valB = '';
                }
                
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderPianos(sorted);
        }

        // Render piano's als tabel
        function renderPianos(pianos) {
            const tbody = document.getElementById('pianos-tbody');
            const tableContainer = document.getElementById('pianos-table-container');
            const emptyState = document.getElementById('pianos-empty');
            
            if (pianos.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';

            const typeLabels = {
                upright: window.i18n ? window.i18n.t('pianos.upright') : 'Piano',
                grand: window.i18n ? window.i18n.t('pianos.grand') : 'Grand Piano'
            };

            tbody.innerHTML = pianos.map(piano => {
                const customer = allCustomers.find(c => c.id === piano.customerId);
                
                // Service status
                let serviceStatus = '';
                if (piano.lastTuningDate) {
                    const lastTuning = new Date(piano.lastTuningDate);
                    const nextDue = new Date(lastTuning);
                    nextDue.setMonth(nextDue.getMonth() + (piano.serviceInterval || 6));
                    
                    if (nextDue < new Date()) {
                        serviceStatus = `<span class="service-status service-due"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>${lastTuning.toLocaleDateString()}</span>`;
                    } else {
                        serviceStatus = `<span class="service-status service-ok">✓ ${lastTuning.toLocaleDateString()}</span>`;
                    }
                } else {
                    serviceStatus = `<span class="service-status" style="color: var(--gray-400);">-</span>`;
                }

                // Customer cell
                let customerCell = '';
                if (customer) {
                    customerCell = `<a href="/customer-detail.html?id=${customer.id}" class="customer-link" onclick="event.stopPropagation();"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> ${customer.name}</a>`;
                } else {
                    customerCell = `<span class="no-customer">-</span>`;
                }

                return `
                    <tr>
                        <td class="piano-brand-cell">${piano.brand || '-'}</td>
                        <td class="piano-model-cell">${piano.model || '-'}</td>
                        <td class="piano-type-cell">
                            <span class="piano-type-badge ${piano.type}">${typeLabels[piano.type] || '-'}</span>
                        </td>
                        <td class="piano-customer-cell">${customerCell}</td>
                        <td class="piano-service-cell">${serviceStatus}</td>
                        <td class="piano-actions-cell">
                            <div class="action-buttons">
                                <button class="btn-icon edit" onclick="editPiano('${piano.id}')" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                <button class="btn-icon delete" onclick="deletePianoDirectly('${piano.id}', event)" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Delete piano directly from table
        async function deletePianoDirectly(pianoId, event) {
            event.stopPropagation();
            
            const confirmMsg = window.i18n ? window.i18n.t('pianos.confirmDelete') : 'Are you sure you want to delete this piano?';
            if (!confirm(confirmMsg)) return;
            
            try {
                const response = await fetch(`/api/pianos/${pianoId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadPianos();
                    showToast('Piano deleted', 'success');
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Could not delete piano', 'error');
                }
            } catch (error) {
                console.error('Error deleting piano:', error);
                showToast('Something went wrong while deleting', 'error');
            }
        }

        // Open piano modal
        function openPianoModal() {
            currentPianoId = null;
            document.getElementById('modal-title').textContent = 'New Piano';
            document.getElementById('piano-form').reset();
            document.getElementById('piano-id').value = '';
            
            // Reset customer search field
            document.getElementById('piano-customer-search').value = '';
            document.getElementById('piano-customer').value = '';
            
            document.getElementById('service-panel').style.display = 'none';
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('piano-modal').classList.add('active');
        }

        // Refresh pianos
        async function refreshPianos() {
            await loadPianos();
        }

        // Delete piano
        async function deletePiano() {
            if (!currentPianoId) return;
            
            const confirmMsg = window.i18n ? window.i18n.t('pianos.confirmDelete') : 'Are you sure you want to delete this piano?';
            if (!confirm(confirmMsg)) return;
            
            try {
                const response = await fetch(`/api/pianos/${currentPianoId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    closeModal();
                    loadPianos();
                    showToast('Piano deleted', 'success');
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Could not delete piano', 'error');
                }
            } catch (error) {
                console.error('Error deleting piano:', error);
                showToast('Something went wrong while deleting', 'error');
            }
        }

        // Edit piano
        async function editPiano(pianoId) {
            try {
                const response = await fetch(`/api/pianos/${pianoId}`);
                const piano = await response.json();
                
                currentPianoId = pianoId;
                document.getElementById('modal-title').textContent = 'Edit Piano';
                document.getElementById('piano-id').value = piano.id;
                document.getElementById('piano-brand').value = piano.brand || '';
                document.getElementById('piano-model').value = piano.model || '';
                document.getElementById('piano-type').value = piano.type || 'upright';
                document.getElementById('piano-year').value = piano.year || '';
                document.getElementById('piano-serial').value = piano.serialNumber || '';
                document.getElementById('piano-finish').value = piano.finish || '';
                
                // Set customer via search field
                setCustomerSearchValue(piano.customerId);
                
                document.getElementById('piano-condition').value = piano.condition || 'good';
                document.getElementById('piano-location').value = piano.location || '';
                document.getElementById('piano-interval').value = piano.serviceInterval || 6;
                document.getElementById('piano-notes').value = piano.notes || '';
                
                // Show service panel and delete button
                document.getElementById('service-panel').style.display = 'block';
                document.getElementById('delete-btn').style.display = 'inline-flex';
                renderServiceHistory(piano.serviceHistory || []);
                
                document.getElementById('piano-modal').classList.add('active');
            } catch (error) {
                console.error('Error loading piano:', error);
                alert('Could not load piano');
            }
        }

        // Render service history
        function renderServiceHistory(services) {
            const list = document.getElementById('service-list');
            
            if (services.length === 0) {
                const noHistoryText = window.i18n ? window.i18n.t('pianos.noServiceHistory') : 'No service history yet';
                list.innerHTML = `<p style="color: #666; text-align: center;">${noHistoryText}</p>`;
                return;
            }

            const tuningIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
            const repairIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>';
            const settingsIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>';
            const voicingIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
            const cleaningIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="m13 11 9-9"/><path d="M14.5 21.5 22 14l-1.5-1.5-7.5 7.5L14.5 21.5z"/><path d="M4.5 9.5 12 2l1.5 1.5-7.5 7.5L4.5 9.5z"/><path d="M9.5 4.5 2 12l1.5 1.5 7.5-7.5L9.5 4.5z"/><path d="m14 14-9 9"/></svg>';
            const fileTextIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>';
            const typeLabels = {
                tuning: tuningIcon + 'Tuning',
                repair: repairIcon + 'Repair',
                regulation: settingsIcon + 'Regulation',
                voicing: voicingIcon + 'Voicing',
                cleaning: cleaningIcon + 'Cleaning',
                other: fileTextIcon + 'Other'
            };

            list.innerHTML = services.map(service => `
                <div class="service-item">
                    <div class="service-item-header">
                        <span class="service-type">${typeLabels[service.type] || service.type}</span>
                        <span class="service-date">${new Date(service.date).toLocaleDateString('en-US')}</span>
                    </div>
                    ${service.workPerformed ? `<div class="service-notes">${service.workPerformed}</div>` : ''}
                    ${service.pitchAfter ? `<div class="service-notes">Pitch: ${service.pitchAfter} Hz</div>` : ''}
                </div>
            `).join('');
        }

        // Close modal
        function closeModal() {
            document.getElementById('piano-modal').classList.remove('active');
            currentPianoId = null;
        }

        // Open service modal
        function openServiceModal() {
            document.getElementById('service-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('service-form').reset();
            document.getElementById('service-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('service-modal').classList.add('active');
        }

        // Close service modal
        function closeServiceModal() {
            document.getElementById('service-modal').classList.remove('active');
        }

        // Submit piano form
        document.getElementById('piano-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const pianoId = document.getElementById('piano-id').value;
            const data = {
                brand: document.getElementById('piano-brand').value,
                model: document.getElementById('piano-model').value,
                type: document.getElementById('piano-type').value,
                year: document.getElementById('piano-year').value ? parseInt(document.getElementById('piano-year').value) : null,
                serialNumber: document.getElementById('piano-serial').value,
                finish: document.getElementById('piano-finish').value,
                customerId: document.getElementById('piano-customer').value || null,
                condition: document.getElementById('piano-condition').value,
                location: document.getElementById('piano-location').value,
                serviceInterval: parseInt(document.getElementById('piano-interval').value),
                notes: document.getElementById('piano-notes').value
            };

            try {
                const url = pianoId ? `/api/pianos/${pianoId}` : '/api/pianos';
                const method = pianoId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    closeModal();
                    loadPianos();
                    showToast(pianoId ? 'Piano updated!' : 'Piano created!', 'success');
                } else {
                    showToast(result.error || 'Something went wrong', 'error');
                }
            } catch (error) {
                console.error('Error saving piano:', error);
                showToast('Something went wrong while saving', 'error');
            }
        });

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('ios-toast');
            const toastMessage = document.getElementById('ios-toast-message');
            
            if (!toast || !toastMessage) return;
            
            toastMessage.textContent = message;
            toast.className = 'ios-toast ' + type;
            
            // Update icon based on type
            const svg = toast.querySelector('svg');
            if (svg) {
                if (type === 'success') {
                    svg.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
                } else if (type === 'error') {
                    svg.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
                }
            }
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide after 2.5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // Submit service form
        document.getElementById('service-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentPianoId) {
                alert('No piano selected');
                return;
            }

            const data = {
                type: document.getElementById('service-type').value,
                date: document.getElementById('service-date').value,
                pitchBefore: document.getElementById('service-pitch-before').value,
                pitchAfter: document.getElementById('service-pitch-after').value,
                workPerformed: document.getElementById('service-work').value,
                observations: document.getElementById('service-observations').value,
                recommendations: document.getElementById('service-recommendations').value
            };

            try {
                const response = await fetch(`/api/pianos/${currentPianoId}/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    closeServiceModal();
                    // Reload piano to show new service
                    editPiano(currentPianoId);
                } else {
                    alert(result.error || 'Something went wrong');
                }
            } catch (error) {
                console.error('Error saving service:', error);
                alert('Something went wrong while saving');
            }
        });

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            let filtered = allPianos.filter(piano => 
                piano.brand?.toLowerCase().includes(query) ||
                piano.model?.toLowerCase().includes(query) ||
                piano.serialNumber?.toLowerCase().includes(query)
            );
            
            // Apply current sort to filtered results
            filtered = applySortToArray(filtered);
            renderPianos(filtered);
        });
        
        // Apply sort to an array without changing currentSort state
        function applySortToArray(pianos) {
            return [...pianos].sort((a, b) => {
                let valA, valB;
                
                switch (currentSort.field) {
                    case 'brand':
                        valA = (a.brand || '').toLowerCase();
                        valB = (b.brand || '').toLowerCase();
                        break;
                    case 'customer':
                        const custA = allCustomers.find(c => c.id === a.customerId);
                        const custB = allCustomers.find(c => c.id === b.customerId);
                        valA = (custA?.name || '').toLowerCase();
                        valB = (custB?.name || '').toLowerCase();
                        break;
                    case 'lastTuning':
                        valA = a.lastTuningDate ? new Date(a.lastTuningDate).getTime() : (currentSort.direction === 'asc' ? Infinity : -Infinity);
                        valB = b.lastTuningDate ? new Date(b.lastTuningDate).getTime() : (currentSort.direction === 'asc' ? Infinity : -Infinity);
                        break;
                    default:
                        valA = '';
                        valB = '';
                }
                
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeServiceModal();
            }
        });

        // Init
        async function init() {
            if (await checkAuth()) {
                await loadCustomers();
                await loadPianos();
                initCustomerSearch();
                
                // Apply default sort (oldest tuning first)
                sortPianos('lastTuning');
            }
        }

        init();
    </script>
    
    <!-- iOS Tab Bar (Mobile Only) -->
    <nav class="ios-tab-bar">
        <a href="/dashboard.html" class="ios-tab-item">
            <span class="ios-tab-icon" data-lucide="calendar"></span>
            <span class="ios-tab-label">Calendar</span>
        </a>
        <a href="/customers.html" class="ios-tab-item">
            <span class="ios-tab-icon" data-lucide="users"></span>
            <span class="ios-tab-label">Customers</span>
        </a>
        <a href="/pianos.html" class="ios-tab-item active">
            <span class="ios-tab-icon" data-lucide="piano"></span>
            <span class="ios-tab-label">Pianos</span>
        </a>
        <a href="/settings.html" class="ios-tab-item">
            <span class="ios-tab-icon" data-lucide="settings"></span>
            <span class="ios-tab-label">Settings</span>
        </a>
        <a href="/guide.html" class="ios-tab-item">
            <span class="ios-tab-icon" data-lucide="help-circle"></span>
            <span class="ios-tab-label">Help</span>
        </a>
    </nav>
</body>
</html>
