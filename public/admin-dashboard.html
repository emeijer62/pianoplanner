<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PianoPlanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="apple-style.css">
    <link rel="stylesheet" href="icons.css?v=20260109">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="icons.js?v=20260109" defer></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.75rem;
        }

        .admin-nav {
            display: flex;
            gap: 1rem;
        }

        .admin-nav a {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .admin-nav a:hover,
        .admin-nav a.active {
            background: var(--light-gray);
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card.pending .value {
            color: #f59e0b;
        }

        .pending-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .pending-section h2 {
            margin: 0 0 1rem 0;
            color: #92400e;
            font-size: 1.1rem;
        }

        .pending-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .pending-user {
            background: white;
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .pending-user-info {
            flex: 1;
        }

        .pending-user-info .name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .pending-user-info .email {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .pending-user-info .date {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .pending-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-approve {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-approve:hover {
            background: #059669;
        }

        .btn-reject {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-reject:hover {
            background: #dc2626;
        }

        .users-table {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .users-table th {
            background: var(--light-gray);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .users-table tr:hover td {
            background: var(--off-white);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-trial {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-expired {
            background: #f3f4f6;
            color: #6b7280;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding: 0.5rem;
            background: var(--light-gray);
            border-radius: var(--radius-lg);
            overflow-x: auto;
        }

        .admin-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .admin-tab:hover {
            background: var(--white);
            color: var(--text-primary);
        }

        .admin-tab.active {
            background: var(--white);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-badge {
            background: #ef4444;
            color: white;
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 999px;
            min-width: 18px;
            text-align: center;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section Cards */
        .section-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-card h2 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Filters Row */
        .filters-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filters-row select,
        .filters-row input {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            min-width: 150px;
        }

        .filters-row input {
            flex: 1;
            min-width: 200px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--white);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination button:hover:not(:disabled) {
            background: var(--light-gray);
        }

        .pagination button.active {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Alerts List */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: var(--radius-md);
            border-left: 3px solid #f59e0b;
        }

        .alert-item.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .alert-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .alert-item .alert-icon {
            flex-shrink: 0;
            color: #f59e0b;
        }

        .alert-item.critical .alert-icon {
            color: #ef4444;
        }

        .alert-item .alert-content {
            flex: 1;
        }

        .alert-item .alert-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* System Status Banner */
        .system-status-banner {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: #d1fae5;
            color: #065f46;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
        }

        .system-status-banner.error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Chart Container */
        .chart-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            padding: 1rem 0;
        }

        .chart-bar {
            flex: 1;
            background: var(--blue);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            position: relative;
        }

        .chart-bar:hover::after {
            content: attr(data-label);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1d1d1f;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Announcements */
        .announcements-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .announcement-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .announcement-card.info {
            border-left: 4px solid var(--blue);
        }

        .announcement-card.warning {
            border-left: 4px solid #f59e0b;
        }

        .announcement-card.success {
            border-left: 4px solid #10b981;
        }

        .announcement-card.error {
            border-left: 4px solid #ef4444;
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .announcement-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .announcement-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .announcement-message {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .announcement-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        /* User Detail Modal */
        .user-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            padding: 0.75rem;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
        }

        .detail-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .detail-item .value {
            font-size: 1rem;
            font-weight: 500;
        }

        /* Severity badges */
        .severity-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .severity-info { background: #dbeafe; color: #1e40af; }
        .severity-warning { background: #fef3c7; color: #92400e; }
        .severity-error { background: #fee2e2; color: #991b1b; }
        .severity-critical { background: #991b1b; color: white; }

        /* Action buttons in tables */
        .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--blue);
            color: white;
        }

        .action-btn.resolve {
            background: #d1fae5;
            color: #065f46;
        }

        .action-btn.resolve:hover {
            background: #10b981;
            color: white;
        }

        .action-btn.view {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-btn.impersonate {
            background: #fef3c7;
            color: #92400e;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-btn.delete:hover {
            background: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <i data-lucide="piano" style="width: 28px; height: 28px;"></i>
            <span>PianoPlanner Admin</span>
        </div>
        <div class="nav-user">
            <span id="impersonate-banner" style="display: none; background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); margin-right: 1rem; font-size: 0.8rem;">
                ðŸ‘¤ Impersonating user
                <button onclick="stopImpersonate()" style="background: #fff; color: #f59e0b; border: none; padding: 0.125rem 0.5rem; border-radius: 3px; margin-left: 0.5rem; cursor: pointer; font-size: 0.75rem;">Stop</button>
            </span>
            <span id="admin-username">Admin</span>
            <button onclick="logout()" class="btn btn-small">Log out</button>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Admin Navigation Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="overview" onclick="switchTab('overview')">
                <i data-lucide="layout-dashboard" style="width: 16px; height: 16px;"></i>
                Overview
            </button>
            <button class="admin-tab" data-tab="users" onclick="switchTab('users')">
                <i data-lucide="users" style="width: 16px; height: 16px;"></i>
                Users
            </button>
            <button class="admin-tab" data-tab="audit" onclick="switchTab('audit')">
                <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                Audit Log
            </button>
            <button class="admin-tab" data-tab="errors" onclick="switchTab('errors')">
                <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                Errors
                <span id="error-badge" class="tab-badge" style="display: none;">0</span>
            </button>
            <button class="admin-tab" data-tab="security" onclick="switchTab('security')">
                <i data-lucide="shield" style="width: 16px; height: 16px;"></i>
                Security
            </button>
            <button class="admin-tab" data-tab="system" onclick="switchTab('system')">
                <i data-lucide="server" style="width: 16px; height: 16px;"></i>
                System
            </button>
            <button class="admin-tab" data-tab="announcements" onclick="switchTab('announcements')">
                <i data-lucide="megaphone" style="width: 16px; height: 16px;"></i>
                Announcements
            </button>
        </div>

        <!-- Tab Content -->
        
        <!-- ==================== OVERVIEW TAB ==================== -->
        <div class="tab-content active" id="tab-overview">
            <div class="admin-header">
                <h1><i data-lucide="layout-dashboard" style="width: 24px; height: 24px;"></i> Dashboard Overview</h1>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="value" id="overview-total-users">-</div>
                </div>
                <div class="stat-card pending">
                    <h3>Awaiting Approval</h3>
                    <div class="value" id="overview-pending-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Active Subscriptions</h3>
                    <div class="value" id="overview-active-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Active Trials</h3>
                    <div class="value" id="overview-trial-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>New Signups (7d)</h3>
                    <div class="value" id="overview-recent-signups">-</div>
                </div>
                <div class="stat-card" id="overview-errors-card">
                    <h3>Unresolved Errors</h3>
                    <div class="value" id="overview-errors">-</div>
                </div>
                <div class="stat-card">
                    <h3>Database Size</h3>
                    <div class="value" id="overview-db-size">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Appointments</h3>
                    <div class="value" id="overview-appointments">-</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section-card">
                <h2>Quick Actions</h2>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="switchTab('users'); showCreateModal();">
                        <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i> Add User
                    </button>
                    <button class="btn btn-secondary" onclick="switchTab('announcements'); showAnnouncementModal();">
                        <i data-lucide="megaphone" style="width: 16px; height: 16px;"></i> New Announcement
                    </button>
                    <button class="btn btn-secondary" onclick="refreshAllData()">
                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i> Refresh Data
                    </button>
                </div>
            </div>

            <!-- Login Activity Chart -->
            <div class="section-card">
                <h2>Login Activity (7 days)</h2>
                <div id="login-chart" class="chart-container"></div>
            </div>

            <!-- Recent Security Alerts -->
            <div class="section-card" id="overview-security-alerts">
                <h2>Recent Security Alerts</h2>
                <div id="recent-alerts-list" class="alerts-list"></div>
            </div>
        </div>

        <!-- ==================== USERS TAB ==================== -->
        <div class="tab-content" id="tab-users">
        <div class="admin-header">
            <h1><i data-lucide="users" style="width: 24px; height: 24px;"></i> User Management</h1>
            <div class="admin-nav">
                <button class="btn btn-primary" onclick="showCreateModal()">+ New User</button>
            </div>
        </div>

        <!-- Statistieken -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="total-users">-</div>
            </div>
            <div class="stat-card pending">
                <h3>Awaiting Approval</h3>
                <div class="value" id="pending-users">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Trials</h3>
                <div class="value" id="trial-users">-</div>
            </div>
            <div class="stat-card">
                <h3>Paid Subscriptions</h3>
                <div class="value" id="paid-users">-</div>
            </div>
        </div>

        <!-- Uitnodigingslink -->
        <div class="invite-link-section" style="background: var(--blue-light, rgba(0, 113, 227, 0.1)); border: 1px solid var(--blue, #0071e3); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 2rem;">
            <h2 style="margin: 0 0 0.5rem 0; color: var(--blue, #0071e3); font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="link" style="width: 20px; height: 20px;"></i> Uitnodigingslink
            </h2>
            <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--gray-600, #424245);">
                Deel deze link met mensen die je wilt uitnodigen. Na registratie moet je hun account hieronder goedkeuren.
            </p>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="text" id="invite-link" readonly value="" style="flex: 1; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 0.9rem; background: white;">
                <button onclick="copyInviteLink()" class="btn-approve" style="white-space: nowrap;">
                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i> KopiÃ«ren
                </button>
            </div>
        </div>

        <!-- Wachtende Goedkeuringen -->
        <div class="pending-section" id="pending-section" style="display: none;">
            <h2><i data-lucide="clock" style="width: 20px; height: 20px;"></i> Wachtend op goedkeuring</h2>
            <div class="pending-list" id="pending-list">
                <!-- Pending users komen hier -->
            </div>
        </div>

        <!-- Alle Gebruikers -->
        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Subscription</th>
                        <th>Registered</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="6" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>

        <!-- ==================== AUDIT LOG TAB ==================== -->
        <div class="tab-content" id="tab-audit">
            <div class="admin-header">
                <h1><i data-lucide="file-text" style="width: 24px; height: 24px;"></i> Audit Log</h1>
                <div class="admin-nav">
                    <button class="btn btn-secondary" onclick="loadAuditLogs()">
                        <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-row">
                <select id="audit-action-filter" onchange="loadAuditLogs()">
                    <option value="">All Actions</option>
                    <option value="login_success">Login Success</option>
                    <option value="login_failed">Login Failed</option>
                    <option value="user_approved">User Approved</option>
                    <option value="user_rejected">User Rejected</option>
                    <option value="admin_impersonate">Impersonate</option>
                    <option value="plan_changed">Plan Changed</option>
                    <option value="settings_changed">Settings Changed</option>
                </select>
                <select id="audit-severity-filter" onchange="loadAuditLogs()">
                    <option value="">All Severities</option>
                    <option value="info">Info</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                    <option value="critical">Critical</option>
                </select>
                <input type="text" id="audit-search" placeholder="Search..." oninput="debounceAuditSearch()">
            </div>

            <!-- Audit Log Table -->
            <div class="users-table">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Details</th>
                            <th>IP Address</th>
                            <th>Severity</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table-body">
                        <tr>
                            <td colspan="6" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="audit-pagination"></div>
        </div>

        <!-- ==================== ERRORS TAB ==================== -->
        <div class="tab-content" id="tab-errors">
            <div class="admin-header">
                <h1><i data-lucide="alert-triangle" style="width: 24px; height: 24px;"></i> Error Log</h1>
                <div class="admin-nav">
                    <button class="btn btn-secondary" onclick="loadErrorLogs()">
                        <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Error Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="stat-card">
                    <h3>Total Errors (7d)</h3>
                    <div class="value" id="error-total">-</div>
                </div>
                <div class="stat-card pending">
                    <h3>Unresolved</h3>
                    <div class="value" id="error-unresolved">-</div>
                </div>
                <div class="stat-card">
                    <h3>API Errors</h3>
                    <div class="value" id="error-api">-</div>
                </div>
                <div class="stat-card">
                    <h3>Sync Errors</h3>
                    <div class="value" id="error-sync">-</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-row">
                <select id="error-category-filter" onchange="loadErrorLogs()">
                    <option value="">All Categories</option>
                    <option value="api">API</option>
                    <option value="sync">Sync</option>
                    <option value="email">Email</option>
                    <option value="database">Database</option>
                    <option value="auth">Auth</option>
                </select>
                <select id="error-resolved-filter" onchange="loadErrorLogs()">
                    <option value="false">Unresolved</option>
                    <option value="">All</option>
                    <option value="true">Resolved</option>
                </select>
                <input type="text" id="error-search" placeholder="Search..." oninput="debounceErrorSearch()">
            </div>

            <!-- Error Log Table -->
            <div class="users-table">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Category</th>
                            <th>Message</th>
                            <th>Path</th>
                            <th>User</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="error-table-body">
                        <tr>
                            <td colspan="7" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="error-pagination"></div>
        </div>

        <!-- ==================== SECURITY TAB ==================== -->
        <div class="tab-content" id="tab-security">
            <div class="admin-header">
                <h1><i data-lucide="shield" style="width: 24px; height: 24px;"></i> Security</h1>
            </div>

            <!-- Security Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Successful Logins (7d)</h3>
                    <div class="value" id="security-success-logins">-</div>
                </div>
                <div class="stat-card pending">
                    <h3>Failed Logins (7d)</h3>
                    <div class="value" id="security-failed-logins">-</div>
                </div>
                <div class="stat-card">
                    <h3>Impersonations (7d)</h3>
                    <div class="value" id="security-impersonations">-</div>
                </div>
                <div class="stat-card">
                    <h3>Security Alerts</h3>
                    <div class="value" id="security-alerts-count">-</div>
                </div>
            </div>

            <!-- Security Alerts -->
            <div class="section-card">
                <h2>Security Alerts</h2>
                <div id="security-alerts-list" class="alerts-list"></div>
            </div>

            <!-- Recent Failed Logins -->
            <div class="section-card">
                <h2>Recent Failed Logins</h2>
                <div class="users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Email/Identifier</th>
                                <th>IP Address</th>
                                <th>User Agent</th>
                            </tr>
                        </thead>
                        <tbody id="failed-logins-body">
                            <tr><td colspan="4" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== SYSTEM TAB ==================== -->
        <div class="tab-content" id="tab-system">
            <div class="admin-header">
                <h1><i data-lucide="server" style="width: 24px; height: 24px;"></i> System Health</h1>
                <div class="admin-nav">
                    <button class="btn btn-secondary" onclick="loadSystemHealth()">
                        <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- System Status -->
            <div class="system-status-banner" id="system-status">
                <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
                <span>System Status: <strong>Healthy</strong></span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Uptime</h3>
                    <div class="value" id="system-uptime">-</div>
                </div>
                <div class="stat-card">
                    <h3>Memory Used</h3>
                    <div class="value" id="system-memory">-</div>
                </div>
                <div class="stat-card">
                    <h3>Database Size</h3>
                    <div class="value" id="system-db-size">-</div>
                </div>
                <div class="stat-card">
                    <h3>Node Version</h3>
                    <div class="value" id="system-node">-</div>
                </div>
            </div>

            <!-- Database Tables -->
            <div class="section-card">
                <h2>Database Tables</h2>
                <div class="users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Table Name</th>
                                <th>Row Count</th>
                            </tr>
                        </thead>
                        <tbody id="db-tables-body">
                            <tr><td colspan="2" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== ANNOUNCEMENTS TAB ==================== -->
        <div class="tab-content" id="tab-announcements">
            <div class="admin-header">
                <h1><i data-lucide="megaphone" style="width: 24px; height: 24px;"></i> Announcements</h1>
                <div class="admin-nav">
                    <button class="btn btn-primary" onclick="showAnnouncementModal()">+ New Announcement</button>
                </div>
            </div>

            <!-- Announcements List -->
            <div id="announcements-list" class="announcements-list">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal" id="reject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reject User</h2>
                <button class="modal-close" onclick="closeRejectModal()">&times;</button>
            </div>
            <form id="reject-form">
                <input type="hidden" id="reject-user-id">
                <div class="form-group">
                    <label>Reason (optional)</label>
                    <textarea id="reject-reason" rows="3" placeholder="Provide a reason for the rejection..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRejectModal()">Cancel</button>
                    <button type="submit" class="btn-reject">Reject</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Set Plan Modal -->
    <div class="modal" id="plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Subscription</h2>
                <button class="modal-close" onclick="closePlanModal()">&times;</button>
            </div>
            <form id="plan-form">
                <input type="hidden" id="plan-user-id">
                <div class="form-group">
                    <label>Plan</label>
                    <select id="plan-select">
                        <option value="trial">Trial (14 days)</option>
                        <option value="starter">Starter</option>
                        <option value="professional">Professional</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePlanModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New User</h2>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <form id="create-form">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="create-name" required placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="create-email" required placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="create-password" required minlength="6" placeholder="Minimum 6 characters">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="create-status">
                        <option value="approved">Approved</option>
                        <option value="pending">Awaiting approval</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subscription</label>
                    <select id="create-plan">
                        <option value="trial">Trial (14 days)</option>
                        <option value="starter">Starter</option>
                        <option value="professional">Professional</option>
                        <option value="enterprise">Enterprise</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-name" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="edit-password" placeholder="Leave empty to keep current" minlength="6">
                    <small style="color: var(--text-muted); font-size: 0.75rem;">Leave empty to keep current password</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal" id="user-detail-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>User Details</h2>
                <button class="modal-close" onclick="closeUserDetailModal()">&times;</button>
            </div>
            <div id="user-detail-content">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Announcement Modal -->
    <div class="modal" id="announcement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Announcement</h2>
                <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
            </div>
            <form id="announcement-form">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="announcement-title" required placeholder="Announcement title">
                </div>
                <div class="form-group">
                    <label>Message *</label>
                    <textarea id="announcement-message" required rows="4" placeholder="Announcement message..."></textarea>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="announcement-type">
                        <option value="info">Info (Blue)</option>
                        <option value="success">Success (Green)</option>
                        <option value="warning">Warning (Orange)</option>
                        <option value="error">Error (Red)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expires At (optional)</label>
                    <input type="datetime-local" id="announcement-expires">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="announcement-banner" checked>
                        Show as banner to users
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAnnouncementModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Error Detail Modal -->
    <div class="modal" id="error-detail-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Error Details</h2>
                <button class="modal-close" onclick="closeErrorDetailModal()">&times;</button>
            </div>
            <div id="error-detail-content">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Check admin status on load
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/admin/status');
                const data = await response.json();
                
                if (!data.isAdmin) {
                    window.location.href = '/admin-login.html';
                    return false;
                }
                
                document.getElementById('admin-username').textContent = data.username;
                return true;
            } catch (error) {
                console.error('Error checking admin status:', error);
                window.location.href = '/admin-login.html';
                return false;
            }
        }

        // Load all users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (!response.ok) {
                    throw new Error('Not authorized');
                }
                
                const users = await response.json();
                
                // Update statistieken
                const pendingCount = users.filter(u => u.approvalStatus === 'pending').length;
                const trialCount = users.filter(u => u.subscription?.status === 'trialing').length;
                const paidCount = users.filter(u => u.subscription?.status === 'active' && u.subscription?.plan !== 'trial').length;
                
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('pending-users').textContent = pendingCount;
                document.getElementById('trial-users').textContent = trialCount;
                document.getElementById('paid-users').textContent = paidCount;
                
                // Show pending section if there are pending users
                const pendingUsers = users.filter(u => u.approvalStatus === 'pending');
                const pendingSection = document.getElementById('pending-section');
                const pendingList = document.getElementById('pending-list');
                
                if (pendingUsers.length > 0) {
                    pendingSection.style.display = 'block';
                    pendingList.innerHTML = pendingUsers.map(user => `
                        <div class="pending-user">
                            <div class="pending-user-info">
                                <div class="name">${user.name || 'Geen naam'}</div>
                                <div class="email">${user.email}</div>
                                <div class="date">Geregistreerd: ${formatDate(user.createdAt)}</div>
                            </div>
                            <div class="pending-actions">
                                <button class="btn-approve" onclick="approveUser('${user.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg> Goedkeuren</button>
                                <button class="btn-reject" onclick="showRejectModal('${user.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> Afwijzen</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    pendingSection.style.display = 'none';
                }
                
                // Fill the table
                const tbody = document.getElementById('users-table-body');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                                <p>No users registered yet</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort: pending first, then by date
                users.sort((a, b) => {
                    if (a.approvalStatus === 'pending' && b.approvalStatus !== 'pending') return -1;
                    if (b.approvalStatus === 'pending' && a.approvalStatus !== 'pending') return 1;
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${user.name || 'No name'}</strong></td>
                        <td>${user.email}</td>
                        <td>${getApprovalBadge(user.approvalStatus)}</td>
                        <td>${getSubscriptionBadge(user.subscription)}</td>
                        <td>${formatDate(user.createdAt)}</td>
                        <td class="user-actions">
                            <button class="action-btn view" onclick="showUserDetail('${user.id}')">View</button>
                            ${user.approvalStatus === 'pending' ? `
                                <button class="btn-approve btn-small" onclick="approveUser('${user.id}')">Approve</button>
                                <button class="btn-reject btn-small" onclick="showRejectModal('${user.id}')">Reject</button>
                            ` : `
                                <button class="action-btn impersonate" onclick="impersonateUser('${user.id}')" title="Login as user">ðŸ‘¤</button>
                                <button class="btn btn-small btn-secondary" onclick="showEditModal('${user.id}')">Edit</button>
                                <button class="btn btn-small btn-secondary" onclick="showPlanModal('${user.id}')">Plan</button>
                                <button class="action-btn delete" onclick="deleteUser('${user.id}')" title="Delete user">ðŸ—‘ï¸</button>
                            `}
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state" style="color: #ef4444;">
                            Error loading users
                        </td>
                    </tr>
                `;
            }
        }

        // Approve user
        async function approveUser(userId) {
            if (!confirm('Are you sure you want to approve this user?')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startTrial: true })
                });
                
                if (response.ok) {
                    alert('User approved! A 14-day trial period has started.');
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Could not approve'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        }

        // Show reject modal
        function showRejectModal(userId) {
            document.getElementById('reject-user-id').value = userId;
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-modal').classList.add('active');
        }

        function closeRejectModal() {
            document.getElementById('reject-modal').classList.remove('active');
        }

        // Reject user
        document.getElementById('reject-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('reject-user-id').value;
            const reason = document.getElementById('reject-reason').value;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    alert('User rejected');
                    closeRejectModal();
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Could not reject'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        });

        // Show plan modal
        function showPlanModal(userId) {
            document.getElementById('plan-user-id').value = userId;
            document.getElementById('plan-modal').classList.add('active');
        }

        function closePlanModal() {
            document.getElementById('plan-modal').classList.remove('active');
        }

        // Set plan
        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('plan-user-id').value;
            const plan = document.getElementById('plan-select').value;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/set-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plan })
                });
                
                if (response.ok) {
                    alert('Plan updated');
                    closePlanModal();
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Could not set plan'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        });

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This cannot be undone!')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('User deleted');
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Could not delete'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        }

        // ==================== CREATE USER ====================
        
        function showCreateModal() {
            document.getElementById('create-name').value = '';
            document.getElementById('create-email').value = '';
            document.getElementById('create-password').value = '';
            document.getElementById('create-status').value = 'approved';
            document.getElementById('create-plan').value = 'trial';
            document.getElementById('create-modal').classList.add('active');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('create-name').value;
            const email = document.getElementById('create-email').value;
            const password = document.getElementById('create-password').value;
            const approvalStatus = document.getElementById('create-status').value;
            const plan = document.getElementById('create-plan').value;
            
            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, approvalStatus, plan })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('User created!');
                    closeCreateModal();
                    loadUsers();
                } else {
                    alert('Error: ' + (data.error || 'Could not create user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        });

        // ==================== EDIT USER ====================
        
        async function showEditModal(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                if (!response.ok) {
                    throw new Error('Could not fetch user');
                }
                
                const user = await response.json();
                
                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-name').value = user.name || '';
                document.getElementById('edit-email').value = user.email || '';
                document.getElementById('edit-password').value = '';
                document.getElementById('edit-modal').classList.add('active');
            } catch (error) {
                console.error('Error:', error);
                alert('Could not load user');
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-name').value;
            const email = document.getElementById('edit-email').value;
            const password = document.getElementById('edit-password').value;
            
            const updateData = { name, email };
            if (password) {
                updateData.password = password;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('User updated!');
                    closeEditModal();
                    loadUsers();
                } else {
                    alert('Error: ' + (data.error || 'Could not update user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        });

        // Logout
        async function logout() {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                window.location.href = '/admin-login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Helper functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function getApprovalBadge(status) {
            switch (status) {
                case 'pending':
                    return '<span class="status-badge status-pending">Pending</span>';
                case 'approved':
                    return '<span class="status-badge status-approved">Approved</span>';
                case 'rejected':
                    return '<span class="status-badge status-rejected">Rejected</span>';
                default:
                    return '<span class="status-badge status-approved">Approved</span>';
            }
        }

        function getSubscriptionBadge(sub) {
            if (!sub) return '<span class="status-badge status-expired">None</span>';
            
            switch (sub.status) {
                case 'trialing':
                    return '<span class="status-badge status-trial">Trial</span>';
                case 'active':
                    return `<span class="status-badge status-active">${sub.plan || 'Active'}</span>`;
                case 'trial_expired':
                    return '<span class="status-badge status-expired">Trial expired</span>';
                default:
                    return `<span class="status-badge status-expired">${sub.status || 'Unknown'}</span>`;
            }
        }

        // Copy invite link function
        function copyInviteLink() {
            const input = document.getElementById('invite-link');
            input.select();
            document.execCommand('copy');
            
            // Show feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" style="width: 14px; height: 14px;"></i> Gekopieerd!';
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        }

        // ==================== TAB NAVIGATION ====================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
            
            // Load data for tab
            switch(tabName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'audit':
                    loadAuditLogs();
                    break;
                case 'errors':
                    loadErrorLogs();
                    loadErrorStats();
                    break;
                case 'security':
                    loadSecurityData();
                    break;
                case 'system':
                    loadSystemHealth();
                    break;
                case 'announcements':
                    loadAnnouncements();
                    break;
            }
            
            lucide.createIcons();
        }

        // ==================== OVERVIEW ====================
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/admin/dashboard/stats');
                if (!response.ok) throw new Error('Failed to load stats');
                
                const data = await response.json();
                
                document.getElementById('overview-total-users').textContent = data.users.total;
                document.getElementById('overview-pending-users').textContent = data.users.pending;
                document.getElementById('overview-active-users').textContent = data.users.active;
                document.getElementById('overview-trial-users').textContent = data.users.trial;
                document.getElementById('overview-recent-signups').textContent = data.recentSignups;
                document.getElementById('overview-errors').textContent = data.errors.total;
                document.getElementById('overview-db-size').textContent = data.database.sizeMB + ' MB';
                document.getElementById('overview-appointments').textContent = data.content.appointments;
                
                // Color error card if there are errors
                const errorCard = document.getElementById('overview-errors-card');
                if (data.errors.total > 0) {
                    errorCard.classList.add('pending');
                }
                
                // Load login chart
                renderLoginChart(data.loginStats);
                
                // Load security alerts
                loadRecentSecurityAlerts();
                
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        function renderLoginChart(stats) {
            const container = document.getElementById('login-chart');
            if (!stats || stats.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No login data available</p>';
                return;
            }
            
            // Group by date
            const byDate = {};
            stats.forEach(item => {
                if (!byDate[item.date]) byDate[item.date] = { success: 0, failed: 0 };
                if (item.action === 'login_success') byDate[item.date].success = item.count;
                if (item.action === 'login_failed') byDate[item.date].failed = item.count;
            });
            
            const dates = Object.keys(byDate).sort();
            const maxValue = Math.max(...dates.map(d => byDate[d].success + byDate[d].failed), 1);
            
            container.innerHTML = dates.map(date => {
                const total = byDate[date].success + byDate[date].failed;
                const height = (total / maxValue) * 100;
                return `
                    <div class="chart-bar" style="height: ${height}%;" data-label="${date}: ${byDate[date].success} success, ${byDate[date].failed} failed"></div>
                `;
            }).join('');
        }

        async function loadRecentSecurityAlerts() {
            try {
                const response = await fetch('/api/admin/security-alerts');
                const alerts = await response.json();
                
                const container = document.getElementById('recent-alerts-list');
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No recent security alerts</p>';
                    return;
                }
                
                container.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div class="alert-item ${alert.severity}">
                        <div class="alert-icon">
                            <i data-lucide="${alert.severity === 'critical' ? 'alert-octagon' : 'alert-triangle'}" style="width: 20px; height: 20px;"></i>
                        </div>
                        <div class="alert-content">
                            <strong>${escapeHtml(alert.action.replace(/_/g, ' '))}</strong>
                            <p style="margin: 0.25rem 0 0; font-size: 0.9rem;">${escapeHtml(alert.details || '')}</p>
                            <span class="alert-time">${formatDateTime(alert.timestamp)}</span>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        function refreshAllData() {
            loadOverviewData();
        }

        // ==================== AUDIT LOG ====================
        let auditPage = 0;
        let auditSearchTimeout;

        async function loadAuditLogs(page = 0) {
            auditPage = page;
            const action = document.getElementById('audit-action-filter')?.value || '';
            const severity = document.getElementById('audit-severity-filter')?.value || '';
            const search = document.getElementById('audit-search')?.value || '';
            
            try {
                const params = new URLSearchParams({
                    limit: 50,
                    offset: page * 50,
                    ...(action && { action }),
                    ...(severity && { severity }),
                    ...(search && { search })
                });
                
                const response = await fetch(`/api/admin/audit-logs?${params}`);
                const data = await response.json();
                
                renderAuditTable(data.logs);
                renderPagination('audit-pagination', data.total, page, loadAuditLogs);
            } catch (error) {
                console.error('Error loading audit logs:', error);
            }
        }

        function renderAuditTable(logs) {
            const tbody = document.getElementById('audit-table-body');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No audit logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${formatDateTime(log.timestamp)}</td>
                    <td>${escapeHtml(log.action.replace(/_/g, ' '))}</td>
                    <td>${escapeHtml(log.user_id || '-')}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(log.details || '-')}</td>
                    <td>${escapeHtml(log.ip_address || '-')}</td>
                    <td><span class="severity-badge severity-${log.severity}">${log.severity}</span></td>
                </tr>
            `).join('');
        }

        function debounceAuditSearch() {
            clearTimeout(auditSearchTimeout);
            auditSearchTimeout = setTimeout(() => loadAuditLogs(0), 300);
        }

        // ==================== ERROR LOG ====================
        let errorPage = 0;
        let errorSearchTimeout;

        async function loadErrorLogs(page = 0) {
            errorPage = page;
            const category = document.getElementById('error-category-filter')?.value || '';
            const resolved = document.getElementById('error-resolved-filter')?.value || '';
            const search = document.getElementById('error-search')?.value || '';
            
            try {
                const params = new URLSearchParams({
                    limit: 50,
                    offset: page * 50,
                    ...(category && { category }),
                    ...(resolved !== '' && { resolved }),
                    ...(search && { search })
                });
                
                const response = await fetch(`/api/admin/error-logs?${params}`);
                const data = await response.json();
                
                renderErrorTable(data.errors);
                renderPagination('error-pagination', data.total, page, loadErrorLogs);
            } catch (error) {
                console.error('Error loading error logs:', error);
            }
        }

        async function loadErrorStats() {
            try {
                const response = await fetch('/api/admin/error-stats');
                const stats = await response.json();
                
                document.getElementById('error-total').textContent = stats.totalCount || 0;
                document.getElementById('error-unresolved').textContent = stats.unresolvedCount || 0;
                
                const apiCount = stats.perCategory?.find(c => c.category === 'api')?.count || 0;
                const syncCount = stats.perCategory?.find(c => c.category === 'sync')?.count || 0;
                document.getElementById('error-api').textContent = apiCount;
                document.getElementById('error-sync').textContent = syncCount;
                
                // Update badge
                const badge = document.getElementById('error-badge');
                if (stats.unresolvedCount > 0) {
                    badge.textContent = stats.unresolvedCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading error stats:', error);
            }
        }

        function renderErrorTable(errors) {
            const tbody = document.getElementById('error-table-body');
            
            if (!errors || errors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No errors found</td></tr>';
                return;
            }
            
            tbody.innerHTML = errors.map(err => `
                <tr>
                    <td>${formatDateTime(err.timestamp)}</td>
                    <td><span class="severity-badge severity-${err.category === 'api' ? 'warning' : 'error'}">${err.category}</span></td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(err.message || '-')}</td>
                    <td>${escapeHtml(err.request_path || '-')}</td>
                    <td>${escapeHtml(err.user_id || '-')}</td>
                    <td>${err.resolved ? '<span class="status-badge status-approved">Resolved</span>' : '<span class="status-badge status-pending">Open</span>'}</td>
                    <td>
                        <button class="action-btn view" onclick="showErrorDetail(${err.id})">View</button>
                        ${!err.resolved ? `<button class="action-btn resolve" onclick="resolveError(${err.id})">Resolve</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function debounceErrorSearch() {
            clearTimeout(errorSearchTimeout);
            errorSearchTimeout = setTimeout(() => loadErrorLogs(0), 300);
        }

        async function resolveError(errorId) {
            const notes = prompt('Resolution notes (optional):');
            try {
                const response = await fetch(`/api/admin/error-logs/${errorId}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (response.ok) {
                    loadErrorLogs(errorPage);
                    loadErrorStats();
                } else {
                    alert('Failed to resolve error');
                }
            } catch (error) {
                console.error('Error resolving:', error);
            }
        }

        function showErrorDetail(errorId) {
            // TODO: Implement error detail modal
            alert('Error detail view coming soon');
        }

        function closeErrorDetailModal() {
            document.getElementById('error-detail-modal').classList.remove('active');
        }

        // ==================== SECURITY ====================
        async function loadSecurityData() {
            try {
                // Load audit logs for security tab
                const logsResponse = await fetch('/api/admin/audit-logs?action=login_failed&limit=20');
                const logsData = await logsResponse.json();
                
                // Load stats
                const statsResponse = await fetch('/api/admin/dashboard/stats');
                const stats = await statsResponse.json();
                
                // Calculate from login stats
                let successCount = 0, failedCount = 0;
                if (stats.loginStats) {
                    stats.loginStats.forEach(item => {
                        if (item.action === 'login_success') successCount += item.count;
                        if (item.action === 'login_failed') failedCount += item.count;
                    });
                }
                
                document.getElementById('security-success-logins').textContent = successCount;
                document.getElementById('security-failed-logins').textContent = failedCount;
                
                // Load impersonation count
                const impersonateResponse = await fetch('/api/admin/audit-logs?action=admin_impersonate&limit=100');
                const impersonateData = await impersonateResponse.json();
                document.getElementById('security-impersonations').textContent = impersonateData.logs?.length || 0;
                
                // Load security alerts
                const alertsResponse = await fetch('/api/admin/security-alerts');
                const alerts = await alertsResponse.json();
                document.getElementById('security-alerts-count').textContent = alerts?.length || 0;
                
                // Render alerts
                const alertsContainer = document.getElementById('security-alerts-list');
                if (!alerts || alerts.length === 0) {
                    alertsContainer.innerHTML = '<p style="color: var(--text-muted);">No security alerts</p>';
                } else {
                    alertsContainer.innerHTML = alerts.slice(0, 10).map(alert => `
                        <div class="alert-item ${alert.severity}">
                            <div class="alert-icon">
                                <i data-lucide="alert-triangle" style="width: 20px; height: 20px;"></i>
                            </div>
                            <div class="alert-content">
                                <strong>${escapeHtml(alert.action.replace(/_/g, ' '))}</strong>
                                <p style="margin: 0.25rem 0 0; font-size: 0.9rem;">${escapeHtml(alert.details || '')}</p>
                                <span class="alert-time">${formatDateTime(alert.timestamp)} - IP: ${escapeHtml(alert.ip_address || 'unknown')}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Render failed logins
                const failedBody = document.getElementById('failed-logins-body');
                if (!logsData.logs || logsData.logs.length === 0) {
                    failedBody.innerHTML = '<tr><td colspan="4" class="empty-state">No failed login attempts</td></tr>';
                } else {
                    failedBody.innerHTML = logsData.logs.map(log => `
                        <tr>
                            <td>${formatDateTime(log.timestamp)}</td>
                            <td>${escapeHtml(log.details || '-')}</td>
                            <td>${escapeHtml(log.ip_address || '-')}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(log.user_agent || '-')}</td>
                        </tr>
                    `).join('');
                }
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading security data:', error);
            }
        }

        // ==================== SYSTEM HEALTH ====================
        async function loadSystemHealth() {
            try {
                const response = await fetch('/api/admin/system/health');
                const data = await response.json();
                
                // Update status banner
                const banner = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    banner.innerHTML = '<i data-lucide="check-circle" style="width: 24px; height: 24px;"></i><span>System Status: <strong>Healthy</strong></span>';
                    banner.classList.remove('error');
                } else {
                    banner.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>System Status: <strong>Error</strong></span>';
                    banner.classList.add('error');
                }
                
                // Update stats
                document.getElementById('system-uptime').textContent = data.uptime?.formatted || '-';
                document.getElementById('system-memory').textContent = data.memory?.heapUsed || '-';
                document.getElementById('system-db-size').textContent = (data.database?.sizeMB || 0) + ' MB';
                document.getElementById('system-node').textContent = data.nodeVersion || '-';
                
                // Render table rows
                const tbody = document.getElementById('db-tables-body');
                if (data.database?.tables) {
                    tbody.innerHTML = Object.entries(data.database.tables).map(([name, count]) => `
                        <tr>
                            <td>${escapeHtml(name)}</td>
                            <td>${count.toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading system health:', error);
            }
        }

        // ==================== ANNOUNCEMENTS ====================
        async function loadAnnouncements() {
            try {
                const response = await fetch('/api/admin/announcements');
                const announcements = await response.json();
                
                const container = document.getElementById('announcements-list');
                
                if (!announcements || announcements.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i data-lucide="megaphone" style="width: 48px; height: 48px;"></i><p>No announcements yet</p></div>';
                    lucide.createIcons();
                    return;
                }
                
                container.innerHTML = announcements.map(ann => `
                    <div class="announcement-card ${ann.type}">
                        <div class="announcement-header">
                            <span class="announcement-title">${escapeHtml(ann.title)}</span>
                            <span class="announcement-meta">
                                ${ann.show_banner ? 'ðŸ”” Banner' : ''} 
                                ${ann.expires_at ? `Expires: ${formatDate(ann.expires_at)}` : 'No expiry'}
                            </span>
                        </div>
                        <p class="announcement-message">${escapeHtml(ann.message)}</p>
                        <div class="announcement-meta">Created by ${escapeHtml(ann.created_by || 'admin')} on ${formatDateTime(ann.created_at)}</div>
                        <div class="announcement-actions">
                            <button class="action-btn delete" onclick="deleteAnnouncement(${ann.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        function showAnnouncementModal() {
            document.getElementById('announcement-form').reset();
            document.getElementById('announcement-modal').classList.add('active');
        }

        function closeAnnouncementModal() {
            document.getElementById('announcement-modal').classList.remove('active');
        }

        document.getElementById('announcement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                title: document.getElementById('announcement-title').value,
                message: document.getElementById('announcement-message').value,
                type: document.getElementById('announcement-type').value,
                expiresAt: document.getElementById('announcement-expires').value || null,
                showBanner: document.getElementById('announcement-banner').checked
            };
            
            try {
                const response = await fetch('/api/admin/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeAnnouncementModal();
                    loadAnnouncements();
                } else {
                    const result = await response.json();
                    alert('Error: ' + (result.error || 'Could not create announcement'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        });

        async function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;
            
            try {
                const response = await fetch(`/api/admin/announcements/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAnnouncements();
                } else {
                    alert('Failed to delete announcement');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ==================== USER DETAIL ====================
        async function showUserDetail(userId) {
            document.getElementById('user-detail-modal').classList.add('active');
            document.getElementById('user-detail-content').innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/detail`);
                const data = await response.json();
                
                document.getElementById('user-detail-content').innerHTML = `
                    <div class="user-detail-grid">
                        <div class="detail-item">
                            <label>Name</label>
                            <div class="value">${escapeHtml(data.user.name || '-')}</div>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <div class="value">${escapeHtml(data.user.email)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Auth Type</label>
                            <div class="value">${escapeHtml(data.user.authType || 'email')}</div>
                        </div>
                        <div class="detail-item">
                            <label>Status</label>
                            <div class="value">${data.user.approvalStatus || 'approved'}</div>
                        </div>
                        <div class="detail-item">
                            <label>Subscription</label>
                            <div class="value">${data.subscription?.status || 'None'} - ${data.subscription?.plan || ''}</div>
                        </div>
                        <div class="detail-item">
                            <label>Registered</label>
                            <div class="value">${formatDateTime(data.user.createdAt)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Appointments</label>
                            <div class="value">${data.stats.appointments}</div>
                        </div>
                        <div class="detail-item">
                            <label>Customers</label>
                            <div class="value">${data.stats.customers}</div>
                        </div>
                    </div>
                    
                    ${data.company ? `
                        <h3>Company</h3>
                        <p>${escapeHtml(data.company.name || '-')} - ${escapeHtml(data.company.city || '')}</p>
                    ` : ''}
                    
                    <h3>Recent Activity</h3>
                    <div style="max-height: 150px; overflow-y: auto;">
                        ${data.activity?.length ? data.activity.map(a => `
                            <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>${escapeHtml(a.action.replace(/_/g, ' '))}</strong>: ${a.count}x
                                <span style="color: var(--text-muted); font-size: 0.8rem;">Last: ${formatDateTime(a.last_occurrence)}</span>
                            </div>
                        `).join('') : '<p style="color: var(--text-muted);">No recent activity</p>'}
                    </div>
                    
                    <div class="form-actions" style="margin-top: 1.5rem;">
                        <button class="action-btn impersonate" onclick="impersonateUser('${userId}')" style="padding: 0.5rem 1rem;">
                            <i data-lucide="user" style="width: 14px; height: 14px;"></i> Impersonate
                        </button>
                        <button class="btn btn-secondary" onclick="closeUserDetailModal()">Close</button>
                    </div>
                `;
                
                lucide.createIcons();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('user-detail-content').innerHTML = '<p style="color: red;">Error loading user details</p>';
            }
        }

        function closeUserDetailModal() {
            document.getElementById('user-detail-modal').classList.remove('active');
        }

        // ==================== IMPERSONATE ====================
        async function impersonateUser(userId) {
            if (!confirm('Are you sure you want to impersonate this user? You will be logged in as them.')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/impersonate`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Now impersonating: ${data.user.name || data.user.email}\n\nYou will be redirected to the dashboard.`);
                    window.location.href = '/dashboard.html';
                } else {
                    const error = await response.json();
                    alert('Failed to impersonate: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Something went wrong');
            }
        }

        async function stopImpersonate() {
            try {
                const response = await fetch('/api/admin/stop-impersonate', { method: 'POST' });
                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Check if impersonating
        async function checkImpersonating() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                
                if (data.isImpersonating) {
                    document.getElementById('impersonate-banner').style.display = 'inline-flex';
                }
            } catch (error) {
                // Ignore
            }
        }

        // ==================== HELPERS ====================
        function renderPagination(containerId, total, currentPage, loadFn) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(total / 50);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            html += `<button ${currentPage === 0 ? 'disabled' : ''} onclick="${loadFn.name}(${currentPage - 1})">Previous</button>`;
            
            for (let i = 0; i < Math.min(totalPages, 10); i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${loadFn.name}(${i})">${i + 1}</button>`;
            }
            
            html += `<button ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="${loadFn.name}(${currentPage + 1})">Next</button>`;
            
            container.innerHTML = html;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Init
        (async () => {
            const isAdmin = await checkAdminStatus();
            if (isAdmin) {
                loadOverviewData(); // Load overview first
                loadUsers();
                loadErrorStats(); // For badge
                checkImpersonating();
                // Set invite link
                document.getElementById('invite-link').value = window.location.origin + '/invite.html';
            }
        })();

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>