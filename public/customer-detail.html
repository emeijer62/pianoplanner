<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Details - PianoPlanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="apple-style.css">
    <link rel="stylesheet" href="icons.css">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/js/i18n.js"></script>
    <script src="icons.js" defer></script>
    <style>
        .customer-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        .customer-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .customer-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .customer-name {
            font-size: 1.75rem;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .customer-since {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .customer-actions {
            display: flex;
            gap: 8px;
        }

        .customer-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .info-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 24px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .tab-content.active {
            display: block;
        }

        /* Piano's sectie */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .pianos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .piano-card {
            background: var(--light-gray);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .piano-card:hover {
            border-color: var(--accent);
        }

        .piano-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .piano-brand-model {
            font-weight: 600;
            font-size: 1rem;
        }

        .piano-type-badge {
            background: var(--accent);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .piano-type-badge.grand { background: #2e7d32; }
        .piano-type-badge.digital { background: #7b1fa2; }

        .piano-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .piano-service-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .service-ok { color: #2e7d32; }
        .service-due { color: #c62828; }
        .service-soon { color: #f57c00; }

        /* Service Historie */
        .service-history {
            margin-top: 16px;
        }

        .service-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .service-date {
            min-width: 100px;
        }

        .service-date-day {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1;
        }

        .service-date-month {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .service-details {
            flex: 1;
        }

        .service-type {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .service-notes {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .service-pitch {
            background: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
            display: inline-block;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 70%;
            max-width: 800px;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-body {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .modal-footer {
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .modal {
                width: 95%;
                max-width: none;
            }
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-actions {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Afspraken */
        .appointments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .appointment-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--light-gray);
            border-radius: 8px;
            align-items: center;
        }

        .appointment-date {
            text-align: center;
            min-width: 60px;
        }

        .appointment-date-day {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .appointment-date-month {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .appointment-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-content">
            <a href="/dashboard.html" class="nav-brand">
                <span class="nav-logo">üéπ</span>
                <span>PianoPlanner</span>
            </a>
            <div class="nav-links">
                <a href="/dashboard.html" class="nav-link">üìÖ <span data-i18n="nav.dashboard">Calendar</span></a>
                <a href="/customers.html" class="nav-link active">üë• <span data-i18n="nav.customers">Customers</span></a>
                <a href="/pianos.html" class="nav-link">üéπ <span data-i18n="nav.pianos">Pianos</span></a>
                <a href="/settings.html" class="nav-link">‚öôÔ∏è</a>
            </div>
            <div class="nav-actions">
                <a href="/booking.html" class="btn btn-primary btn-sm">+ <span data-i18n="appointments.newAppointment">Appointment</span></a>
                <a href="/auth/logout" class="btn btn-secondary btn-sm" data-i18n="nav.logout">Logout</a>
            </div>
        </div>
    </nav>

    <main class="customer-detail-container">
        <a href="/customers.html" class="back-link">‚Üê Back to customers</a>

        <div id="loading" class="loading">Loading customer data...</div>

        <div id="customer-content" style="display: none;">
            <!-- Customer header -->
            <div class="customer-header">
                <div class="customer-header-top">
                    <div>
                        <h1 class="customer-name" id="customer-name">-</h1>
                        <div class="customer-since" id="customer-since">Customer since -</div>
                    </div>
                    <div class="customer-actions">
                        <button class="btn btn-secondary" onclick="editCustomer()">‚úèÔ∏è Edit</button>
                        <button class="btn btn-primary" onclick="openNewAppointment()">+ Appointment</button>
                    </div>
                </div>
                <div class="customer-info-grid">
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value" id="customer-email">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Phone</span>
                        <span class="info-value" id="customer-phone">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Address</span>
                        <span class="info-value" id="customer-address">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Notes</span>
                        <span class="info-value" id="customer-notes">-</span>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" data-tab="pianos">üéπ Pianos</button>
                    <button class="tab" data-tab="history">üìã Service History</button>
                    <button class="tab" data-tab="appointments">üìÖ Appointments</button>
                </div>

                <!-- Pianos tab -->
                <div id="tab-pianos" class="tab-content active">
                    <div class="section-header">
                        <h3 class="section-title">Pianos of this customer</h3>
                        <button class="btn btn-primary btn-small" onclick="openAddPianoModal()">+ Add piano</button>
                    </div>
                    <div id="pianos-list" class="pianos-grid">
                        <div class="empty-state">
                            <div class="empty-state-icon">üéπ</div>
                            <p>No pianos linked yet</p>
                            <button class="btn btn-primary" onclick="openAddPianoModal()">Add first piano</button>
                        </div>
                    </div>
                </div>

                <!-- Service History tab -->
                <div id="tab-history" class="tab-content">
                    <div class="section-header">
                        <h3 class="section-title">Complete service history</h3>
                    </div>
                    <div id="service-history" class="service-history">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>No service performed yet</p>
                        </div>
                    </div>
                </div>

                <!-- Appointments tab -->
                <div id="tab-appointments" class="tab-content">
                    <div class="section-header">
                        <h3 class="section-title">Appointments</h3>
                    </div>
                    <div id="appointments-list" class="appointments-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>No appointments yet</p>
                            <button class="btn btn-primary" onclick="openNewAppointment()">Schedule appointment</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Piano Modal -->
    <div id="piano-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="piano-modal-title">Add piano</h2>
                <button class="modal-close" onclick="closePianoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="piano-form">
                    <input type="hidden" id="piano-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="piano-brand">Brand *</label>
                            <input type="text" id="piano-brand" required placeholder="e.g. Steinway, Yamaha">
                        </div>
                        <div class="form-group">
                            <label for="piano-model">Model</label>
                            <input type="text" id="piano-model" placeholder="e.g. B-211, U3">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="piano-type">Type</label>
                            <select id="piano-type">
                                <option value="upright">Upright piano</option>
                                <option value="grand">Grand piano</option>
                                <option value="digital">Digital piano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="piano-year">Year built</label>
                            <input type="number" id="piano-year" placeholder="e.g. 1985">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="piano-serial">Serial number</label>
                            <input type="text" id="piano-serial" placeholder="e.g. 123456">
                        </div>
                        <div class="form-group">
                            <label for="piano-finish">Finish</label>
                            <input type="text" id="piano-finish" placeholder="e.g. Black gloss">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="piano-location">Location in house</label>
                            <input type="text" id="piano-location" placeholder="e.g. Living room">
                        </div>
                        <div class="form-group">
                            <label for="piano-condition">Condition</label>
                            <select id="piano-condition">
                                <option value="excellent">Excellent</option>
                                <option value="good" selected>Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="piano-last-tuning">Last tuning</label>
                            <input type="date" id="piano-last-tuning">
                        </div>
                        <div class="form-group">
                            <label for="piano-interval">Service interval</label>
                            <select id="piano-interval">
                                <option value="3">Every 3 months</option>
                                <option value="6" selected>Every 6 months</option>
                                <option value="12">Every year</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="piano-notes">Notes</label>
                        <textarea id="piano-notes" rows="3" placeholder="Special notes about the piano..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button id="delete-piano-btn" class="btn btn-danger" onclick="deletePiano()" style="display: none; margin-right: auto;">Delete piano</button>
                <button class="btn btn-secondary" onclick="closePianoModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePiano()">Save</button>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="service-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Add service</h2>
                <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="service-form">
                    <input type="hidden" id="service-piano-id">
                    
                    <div class="form-group">
                        <label for="service-type">Service type</label>
                        <select id="service-type">
                            <!-- Options loaded dynamically from services -->
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="service-date">Date</label>
                            <input type="date" id="service-date" required>
                        </div>
                        <div class="form-group">
                            <label for="service-pitch">Pitch (Hz)</label>
                            <input type="text" id="service-pitch" placeholder="e.g. 440">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="service-notes">Notes</label>
                        <textarea id="service-notes" rows="4" placeholder="What was done, observations, recommendations..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeServiceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveService()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let customerId = null;
        let customerData = null;
        let pianosData = [];
        let servicesData = []; // Available services

        // Get customer ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        customerId = urlParams.get('id');

        if (!customerId) {
            window.location.href = '/customers.html';
        }

        // Load available services for dropdown
        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                if (response.ok) {
                    const data = await response.json();
                    servicesData = Array.isArray(data) ? data : (data.services || []);
                    populateServiceTypes();
                }
            } catch (err) {
                console.error('Error loading services:', err);
                // Fall back to default options
                populateServiceTypes();
            }
        }

        function populateServiceTypes() {
            const select = document.getElementById('service-type');
            select.innerHTML = '';
            
            if (servicesData.length > 0) {
                // Use defined services
                servicesData.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    option.dataset.serviceName = s.name;
                    select.appendChild(option);
                });
            } else {
                // Fallback to defaults
                const defaults = [
                    { value: 'tuning', name: 'Tuning' },
                    { value: 'regulation', name: 'Regulation' },
                    { value: 'voicing', name: 'Voicing' },
                    { value: 'repair', name: 'Repair' },
                    { value: 'inspection', name: 'Inspection' },
                    { value: 'other', name: 'Other' }
                ];
                defaults.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.value;
                    option.textContent = d.name;
                    select.appendChild(option);
                });
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Load customer data
        async function loadCustomer() {
            try {
                const response = await fetch(`/api/customers/${customerId}`);
                if (!response.ok) {
                    throw new Error('Customer not found');
                }
                customerData = await response.json();
                displayCustomer();
                loadPianos();
                loadServiceHistory();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('customer-content').style.display = 'block';
            } catch (error) {
                alert('Customer not found');
                window.location.href = '/customers.html';
            }
        }

        function displayCustomer() {
            document.getElementById('customer-name').textContent = customerData.name;
            document.getElementById('customer-email').innerHTML = customerData.email 
                ? `<a href="mailto:${customerData.email}">${customerData.email}</a>` 
                : '-';
            document.getElementById('customer-phone').innerHTML = customerData.phone 
                ? `<a href="tel:${customerData.phone}">${customerData.phone}</a>` 
                : '-';
            
            const address = [customerData.street, customerData.postalCode, customerData.city]
                .filter(Boolean).join(', ');
            document.getElementById('customer-address').textContent = address || '-';
            document.getElementById('customer-notes').textContent = customerData.notes || '-';
            
            if (customerData.createdAt) {
                const date = new Date(customerData.createdAt);
                document.getElementById('customer-since').textContent = 
                    `Customer since ${date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            }
            
            document.title = `${customerData.name} - PianoPlanner`;
        }

        // Load pianos
        async function loadPianos() {
            try {
                const response = await fetch(`/api/pianos/customer/${customerId}`);
                const data = await response.json();
                pianosData = data.pianos || [];
                displayPianos();
            } catch (error) {
                console.error('Error loading pianos:', error);
            }
        }

        function displayPianos() {
            const container = document.getElementById('pianos-list');
            
            if (pianosData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéπ</div>
                        <p>No pianos linked to this customer yet</p>
                        <button class="btn btn-primary" onclick="openAddPianoModal()">Add first piano</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = pianosData.map(piano => {
                const typeLabel = {
                    'upright': 'Upright',
                    'grand': 'Grand',
                    'digital': 'Digital'
                }[piano.type] || piano.type;

                const serviceStatus = getServiceStatus(piano);

                return `
                    <div class="piano-card" onclick="openPianoDetail('${piano.id}')">
                        <div class="piano-card-header">
                            <div>
                                <div class="piano-brand-model">${piano.brand} ${piano.model || ''}</div>
                                ${piano.year ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">Built ${piano.year}</div>` : ''}
                            </div>
                            <span class="piano-type-badge ${piano.type}">${typeLabel}</span>
                        </div>
                        <div class="piano-info">
                            ${piano.serialNumber ? `Serial: ${piano.serialNumber}` : ''}
                            ${piano.location ? `‚Ä¢ ${piano.location}` : ''}
                        </div>
                        <div class="piano-service-status">
                            <span class="${serviceStatus.class}">${serviceStatus.text}</span>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); openServiceModal('${piano.id}')">+ Service</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getServiceStatus(piano) {
            if (!piano.lastTuningDate) {
                return { class: 'service-due', text: '‚ö†Ô∏è Not yet tuned' };
            }

            const lastService = new Date(piano.lastTuningDate);
            const nextService = new Date(lastService);
            nextService.setMonth(nextService.getMonth() + (piano.serviceInterval || 6));
            
            const now = new Date();
            const daysUntil = Math.ceil((nextService - now) / (1000 * 60 * 60 * 24));

            if (daysUntil < 0) {
                return { class: 'service-due', text: `‚ö†Ô∏è ${Math.abs(daysUntil)} days past service date` };
            } else if (daysUntil < 30) {
                return { class: 'service-soon', text: `‚è∞ Service needed in ${daysUntil} days` };
            } else {
                return { class: 'service-ok', text: `‚úÖ Last: ${lastService.toLocaleDateString('en-US')}` };
            }
        }

        // Load service history for all pianos of this customer
        async function loadServiceHistory() {
            try {
                const response = await fetch(`/api/pianos/customer/${customerId}/services`);
                if (response.ok) {
                    const data = await response.json();
                    displayServiceHistory(data.services || []);
                }
            } catch (error) {
                console.error('Error loading service history:', error);
            }
        }

        function displayServiceHistory(services) {
            const container = document.getElementById('service-history');
            
            if (!services || services.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No service history yet</p>
                    </div>
                `;
                return;
            }

            // Sort by date descending
            services.sort((a, b) => new Date(b.date) - new Date(a.date));

            const typeLabels = {
                'tuning': 'Tuning',
                'regulation': 'Regulation',
                'voicing': 'Voicing',
                'repair': 'Repair',
                'inspection': 'Inspection',
                'other': 'Other'
            };

            container.innerHTML = services.map(service => {
                const date = new Date(service.date);
                return `
                    <div class="service-item">
                        <div class="service-date">
                            <div class="service-date-day">${date.getDate()}</div>
                            <div class="service-date-month">${date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</div>
                        </div>
                        <div class="service-details">
                            <div class="service-type">${typeLabels[service.type] || service.type}</div>
                            <div class="service-piano" style="font-size: 0.85rem; color: var(--accent);">
                                ${service.pianoName || 'Piano'}
                            </div>
                            ${service.notes ? `<div class="service-notes">${service.notes}</div>` : ''}
                            ${service.pitch ? `<span class="service-pitch">üéµ ${service.pitch} Hz</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Piano Modal
        function openAddPianoModal() {
            document.getElementById('piano-modal-title').textContent = 'Add piano';
            document.getElementById('piano-form').reset();
            document.getElementById('piano-id').value = '';
            document.getElementById('delete-piano-btn').style.display = 'none';
            document.getElementById('piano-modal').classList.add('active');
        }

        function openPianoDetail(pianoId) {
            const piano = pianosData.find(p => p.id === pianoId);
            if (!piano) return;

            document.getElementById('piano-modal-title').textContent = 'Edit piano';
            document.getElementById('piano-id').value = piano.id;
            document.getElementById('piano-brand').value = piano.brand || '';
            document.getElementById('piano-model').value = piano.model || '';
            document.getElementById('piano-type').value = piano.type || 'upright';
            document.getElementById('piano-year').value = piano.year || '';
            document.getElementById('piano-serial').value = piano.serialNumber || '';
            document.getElementById('piano-finish').value = piano.finish || '';
            document.getElementById('piano-location').value = piano.location || '';
            document.getElementById('piano-condition').value = piano.condition || 'good';
            document.getElementById('piano-last-tuning').value = piano.lastTuningDate ? piano.lastTuningDate.split('T')[0] : '';
            document.getElementById('piano-interval').value = piano.serviceInterval || 6;
            document.getElementById('piano-notes').value = piano.notes || '';

            // Show delete button for existing pianos
            document.getElementById('delete-piano-btn').style.display = 'inline-flex';

            document.getElementById('piano-modal').classList.add('active');
        }

        function closePianoModal() {
            document.getElementById('piano-modal').classList.remove('active');
            document.getElementById('delete-piano-btn').style.display = 'none';
        }

        async function deletePiano() {
            const pianoId = document.getElementById('piano-id').value;
            if (!pianoId) return;

            const piano = pianosData.find(p => p.id === pianoId);
            const pianoName = piano ? `${piano.brand} ${piano.model || ''}`.trim() : 'this piano';

            if (!confirm(`Are you sure you want to delete "${pianoName}"?\n\nThis will also delete all service history for this piano.\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/pianos/${pianoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log(`üóëÔ∏è Piano deleted: ${pianoName}`);
                    closePianoModal();
                    loadPianos();
                    loadServiceHistory();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Could not delete piano');
                }
            } catch (error) {
                console.error('Error deleting piano:', error);
                alert('Could not delete piano. Please try again.');
            }
        }

        async function savePiano() {
            const pianoId = document.getElementById('piano-id').value;
            const pianoData = {
                customerId: customerId,
                brand: document.getElementById('piano-brand').value,
                model: document.getElementById('piano-model').value,
                type: document.getElementById('piano-type').value,
                year: document.getElementById('piano-year').value ? parseInt(document.getElementById('piano-year').value) : null,
                serialNumber: document.getElementById('piano-serial').value,
                finish: document.getElementById('piano-finish').value,
                location: document.getElementById('piano-location').value,
                condition: document.getElementById('piano-condition').value,
                lastTuningDate: document.getElementById('piano-last-tuning').value || null,
                serviceInterval: parseInt(document.getElementById('piano-interval').value),
                notes: document.getElementById('piano-notes').value
            };

            try {
                const url = pianoId ? `/api/pianos/${pianoId}` : '/api/pianos';
                const method = pianoId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pianoData)
                });

                if (response.ok) {
                    closePianoModal();
                    loadPianos();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error saving');
                }
            } catch (error) {
                alert('Error saving');
            }
        }

        // Service Modal
        function openServiceModal(pianoId) {
            document.getElementById('service-piano-id').value = pianoId;
            document.getElementById('service-form').reset();
            document.getElementById('service-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('service-pitch').value = '440';
            document.getElementById('service-modal').classList.add('active');
        }

        function closeServiceModal() {
            document.getElementById('service-modal').classList.remove('active');
        }

        async function saveService() {
            const pianoId = document.getElementById('service-piano-id').value;
            const serviceSelect = document.getElementById('service-type');
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            
            const serviceData = {
                type: serviceSelect.value,
                typeName: selectedOption.dataset.serviceName || selectedOption.textContent,
                date: document.getElementById('service-date').value,
                pitch: document.getElementById('service-pitch').value,
                notes: document.getElementById('service-notes').value
            };

            // Get piano info for logging
            const piano = pianosData.find(p => p.id === pianoId);
            const pianoName = piano ? `${piano.brand} ${piano.model || ''}`.trim() : 'Unknown piano';

            try {
                const response = await fetch(`/api/pianos/${pianoId}/service`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(serviceData)
                });

                if (response.ok) {
                    console.log(`üîß Service logged: ${serviceData.typeName} on ${pianoName} (${serviceData.date})`);
                    closeServiceModal();
                    loadPianos();
                    loadServiceHistory();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error saving');
                }
            } catch (error) {
                alert('Error saving');
            }
        }

        function editCustomer() {
            window.location.href = `/customers.html?edit=${customerId}`;
        }

        function openNewAppointment() {
            window.location.href = `/booking.html?customer=${customerId}`;
        }

        // Load on page load
        loadCustomer();
        loadServices();
    </script>
</body>
</html>
